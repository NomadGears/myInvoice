<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NomadGears Rental Invoice</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet" />
  <style>
    /* ... your existing CSS unchanged except for color variables and minor adjustments ... */
    :root {
      --theme: #F5F5DC; /* Beige */
      --theme-light: #faf9f5;
      --theme-dark: #d6d5c4;
    }
    body {
      background: var(--theme-light);
      margin: 0;
      padding: 0;
      font-family: 'Roboto', Arial, sans-serif;
      color: #000;
    }
    /* (Include all your existing CSS here from previous code, with text color black) */
    /* For brevity, omitted here; use your previous full CSS */
  </style>
</head>
<body>
  <div class="invoice-box" id="invoice">
    <!-- Your existing invoice HTML content here -->
    <!-- Logo, address, customer details, items table, payment section, etc. -->
    <!-- Use the full HTML from your previous code without change -->
    <!-- For brevity, omitted here; use your previous full HTML -->
  </div>

  <!-- PDF Preview Modal -->
  <div id="previewModal" class="preview-modal" style="display:none;">
    <div class="preview-content">
      <img id="previewImg" src="" alt="Invoice Preview" />
      <div class="preview-actions">
        <button onclick="downloadPDF()">Download PDF</button>
        <button onclick="sharePDF()">Share PDF</button>
        <button class="close-btn" onclick="closePreview()">Close</button>
      </div>
    </div>
  </div>

  <!-- JS Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Your existing JS for adding items, updating customer info, etc.
    // For brevity, omitted here; use your previous full JS except previewPDF, downloadPDF, sharePDF functions

    // Improved PDF generation with page splitting and JPEG compression
    async function previewPDF() {
      setDateTime();
      updateCustomerInfo();

      document.body.classList.add("pdf-mode");
      const invoice = document.getElementById("invoice");

      // Use html2canvas with moderate scale
      const canvas = await html2canvas(invoice, { scale: 1.5, useCORS: true });

      const pdf = new window.jspdf.jsPDF('p', 'px', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(canvas);
      const canvasWidth = canvas.width;
      const canvasHeight = canvas.height;

      // Calculate scale to fit width
      const scale = pdfWidth / canvasWidth;
      const scaledHeight = canvasHeight * scale;

      let position = 0;
      let page = 0;
      const pageHeightPx = pdfHeight / scale; // Height in canvas pixels per PDF page

      while (position < canvasHeight) {
        // Create a canvas for the current page slice
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = canvasWidth;
        pageCanvas.height = Math.min(pageHeightPx, canvasHeight - position);
        const ctx = pageCanvas.getContext('2d');

        // Draw the slice of the original canvas onto the page canvas
        ctx.drawImage(canvas, 0, position, canvasWidth, pageCanvas.height, 0, 0, canvasWidth, pageCanvas.height);

        // Convert page canvas to JPEG data URL with quality 0.75
        const imgData = pageCanvas.toDataURL('image/jpeg', 0.75);

        // Add image to PDF at position (0,0) with full width and scaled height
        pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pageCanvas.height * scale);

        position += pageHeightPx;
        page++;

        if (position < canvasHeight) {
          pdf.addPage();
        }
      }

      // Save the blob for download/share
      lastPdfBlob = pdf.output('blob');
      // Show preview image of first page
      document.getElementById('previewImg').src = canvas.toDataURL('image/jpeg', 0.75);
      document.getElementById('previewModal').style.display = 'flex';
      document.body.classList.remove('pdf-mode');
    }

    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
    }

    function downloadPDF() {
      if (lastPdfBlob) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(lastPdfBlob);
        a.download = 'NomadGears_Invoice.pdf';
        a.click();
      }
    }

    async function sharePDF() {
      if (!lastPdfBlob) return;
      if (navigator.canShare && navigator.canShare({ files: [new File([''], 'dummy.pdf', { type: 'application/pdf' })] })) {
        const file = new File([lastPdfBlob], 'NomadGears_Invoice.pdf', { type: 'application/pdf' });
        try {
          await navigator.share({
            files: [file],
            title: 'NomadGears Invoice',
            text: 'Here is your invoice from NomadGears.',
          });
        } catch (e) {
          alert('Sharing cancelled or failed.');
        }
      } else {
        alert('Sharing PDF is not supported on this device/browser. Please download and share manually.');
      }
    }

    // Initialize your other functions here (setDateTime, updateCustomerInfo, addItem, renderTable, etc.)
    // Call renderTable() on load

  </script>
</body>
</html>
